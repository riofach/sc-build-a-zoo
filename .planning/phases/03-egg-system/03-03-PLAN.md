---
phase: 03-egg-system
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - features/plot-manager.lua
  - features/egg-hatcher.lua
  - features/egg-system.lua
autonomous: true

must_haves:
  truths:
    - "Script dapat mendeteksi empty plots di player area"
    - "Script dapat place egg ke plot kosong"
    - "Script dapat mendeteksi eggs yang ready hatch"
    - "Script dapat hatch eggs dengan proper timing"
    - "Complete egg loop berjalan: monitor → buy → place → hatch"
  artifacts:
    - path: "features/plot-manager.lua"
      provides: "Plot detection dan placement"
      exports: ["init", "findEmptyPlot", "placeEgg", "getPlotStatus"]
    - path: "features/egg-hatcher.lua"
      provides: "Hatch detection dan execution"
      exports: ["init", "findReadyEggs", "hatchEgg", "isEggReady"]
    - path: "features/egg-system.lua"
      provides: "Main orchestrator untuk complete egg loop"
      exports: ["init", "start", "stop", "setTargetMutation", "getStats", "getConfig", "setConfig"]
  key_links:
    - from: "features/egg-system.lua"
      to: "features/egg-buyer.lua"
      via: "orchestrates buy cycle"
      pattern: "EggBuyer\\.start"
    - from: "features/egg-system.lua"
      to: "features/plot-manager.lua"
      via: "place egg after buy"
      pattern: "PlotManager\\.placeEgg"
    - from: "features/egg-system.lua"
      to: "features/egg-hatcher.lua"
      via: "hatch ready eggs"
      pattern: "EggHatcher\\.hatchEgg"
    - from: "features/egg-buyer.lua"
      to: "features/plot-manager.lua"
      via: "pre-check hasEmptyPlot before buy"
      pattern: "PlotManager\\.findEmptyPlot"
---

<objective>
Implementasi plot management, egg hatching, dan main orchestrator untuk complete egg loop.

Purpose: Plot manager handles empty plot detection dan egg placement. Egg hatcher handles ready detection dan hatch execution. Egg system orchestrator ties everything together dalam state machine loop.

Output:
- features/plot-manager.lua untuk plot detection dan placement
- features/egg-hatcher.lua untuk hatch detection dan execution
- features/egg-system.lua sebagai main orchestrator
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-egg-system/03-CONTEXT.md
@.planning/phases/03-egg-system/03-RESEARCH.md
@.planning/phases/03-egg-system/03-01-SUMMARY.md
@.planning/phases/03-egg-system/03-02-SUMMARY.md
@core/services.lua
@core/timing.lua
@core/money.lua
@config/egg-types.lua
@features/game-discovery.lua
@features/auto-collect.lua
@features/conveyor-monitor.lua
@features/egg-buyer.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plot-manager.lua module</name>
  <files>features/plot-manager.lua</files>
  <action>
Buat module features/plot-manager.lua untuk plot detection dan placement:

1. **Module state:**
   - `_playerPlots`: Instance, folder containing player's plots
   - `_placeRemote`: Instance, cached RemoteEvent untuk place
   - `_connections`: table

2. **init():**
   - Discover player plots folder (patterns dari RESEARCH.md):
     a. workspace.Plots.[PlayerName]
     b. workspace.Tycoons.[PlayerName]
     c. workspace.[PlayerName].Plots
     d. workspace.PlayerZoos.[PlayerName]
   - Discover place RemoteEvent (patterns: PlaceEgg, Place, AddEgg, Deposit, StartIncubation)
   - Return boolean success

3. **findEmptyPlot():**
   - Return: plot Instance, prompt Instance (or nil, nil)
   - Detection methods:
     a. ProximityPrompt "Place" yang enabled
     b. Absence of "Egg" or "Animal" child
     c. "Occupied" attribute/value = false
   - Return first empty plot found

4. **placeEgg(plot, prompt):**
   - Return: boolean success
   - If prompt exists: fireproximityprompt(prompt)
   - Else: Fire placeRemote dengan plot argument
   - Wrapped dalam pcall

5. **getPlotStatus():**
   - Return: table dengan {total, empty, occupied}
   - Untuk stats display

6. **hasEmptyPlot():**
   - Return: boolean
   - Quick check tanpa returning plot instance

**Pattern dari RESEARCH.md untuk empty detection:**
```lua
function PlotManager:findEmptyPlot()
    if not self._playerPlots then return nil, nil end
    
    for _, plot in ipairs(self._playerPlots:GetChildren()) do
        -- Method A: ProximityPrompt "Place"
        local prompt = plot:FindFirstChildOfClass("ProximityPrompt")
        if prompt and prompt.Enabled and 
           prompt.ActionText:lower():find("place") then
            return plot, prompt
        end
        
        -- Method B: No Egg/Animal child
        local hasEgg = plot:FindFirstChild("Egg") or 
                       plot:FindFirstChild("Animal")
        if not hasEgg then
            local occupied = plot:GetAttribute("Occupied")
            if not occupied then
                return plot, nil
            end
        end
    end
    
    return nil, nil
end
```
  </action>
  <verify>
1. File features/plot-manager.lua exists
2. PlotManager.init() discovers player plots folder
3. PlotManager.findEmptyPlot() returns plot or nil
4. PlotManager.placeEgg() fires remote/prompt dalam pcall
5. PlotManager.hasEmptyPlot() returns boolean
6. PlotManager.getPlotStatus() returns stats table
  </verify>
  <done>
- Plot manager module complete dengan discovery dan placement
- Empty plot detection via ProximityPrompt atau child absence
- Place egg via fireproximityprompt atau RemoteEvent
- Stats tracking untuk UI display
  </done>
</task>

<task type="auto">
  <name>Task 2: Create egg-hatcher.lua module</name>
  <files>features/egg-hatcher.lua</files>
  <action>
Buat module features/egg-hatcher.lua untuk hatch detection dan execution:

1. **Module state:**
   - `_hatchRemote`: Instance, cached RemoteEvent untuk hatch
   - `_connections`: table
   - `_plotsFolder`: Instance, reference ke player plots

2. **init(plotsFolder):**
   - Store plots folder reference
   - Discover hatch RemoteEvent (patterns: HatchEgg, Hatch, OpenEgg, BreakEgg, Crack)
   - Return boolean success

3. **isEggReady(egg):**
   - Return: boolean
   - Detection methods (dari RESEARCH.md):
     a. GetAttribute("Ready") == true
     b. ProximityPrompt "Hatch" yang enabled
     c. BillboardGui dengan "!" atau "ready" text
     d. Highlight effect yang enabled

4. **findReadyEggs():**
   - Return: table of {egg, plot} pairs
   - Scan semua plots untuk eggs yang ready

5. **hatchEgg(egg, prompt):**
   - Return: boolean success
   - If prompt exists: fireproximityprompt(prompt)
   - Else: Fire hatchRemote dengan egg argument
   - Wrapped dalam pcall

6. **watchForReady(egg, callback):**
   - Optional: Event-based ready detection
   - Listen GetAttributeChangedSignal("Ready")
   - Return connection untuk cleanup

**Pattern dari RESEARCH.md untuk ready detection:**
```lua
function EggHatcher:isEggReady(egg)
    -- Method A: Ready attribute
    if egg:GetAttribute("Ready") == true then
        return true
    end
    
    -- Method B: ProximityPrompt "Hatch"
    local prompt = egg:FindFirstChildOfClass("ProximityPrompt")
    if prompt and prompt.Enabled and 
       prompt.ActionText:lower():find("hatch") then
        return true
    end
    
    -- Method C: Visual indicator
    local billboard = egg:FindFirstChildOfClass("BillboardGui")
    if billboard and billboard.Enabled then
        local textLabel = billboard:FindFirstChildOfClass("TextLabel")
        if textLabel and (textLabel.Text:find("!") or 
           textLabel.Text:lower():find("ready")) then
            return true
        end
    end
    
    -- Method D: Highlight effect
    local highlight = egg:FindFirstChildOfClass("Highlight")
    if highlight and highlight.Enabled then
        return true
    end
    
    return false
end
```
  </action>
  <verify>
1. File features/egg-hatcher.lua exists
2. EggHatcher.init() discovers hatch RemoteEvent
3. EggHatcher.isEggReady() checks 4 detection methods
4. EggHatcher.findReadyEggs() returns array of ready eggs
5. EggHatcher.hatchEgg() fires remote/prompt dalam pcall
6. All game access wrapped dalam pcall
  </verify>
  <done>
- Egg hatcher module complete dengan multi-method detection
- Ready detection via attribute, prompt, visual, highlight
- Hatch execution via fireproximityprompt atau RemoteEvent
- Event-based watching available untuk efficiency
  </done>
</task>

<task type="auto">
  <name>Task 3: Create egg-system.lua main orchestrator</name>
  <files>features/egg-system.lua</files>
  <action>
Buat module features/egg-system.lua sebagai main orchestrator:

1. **Module state:**
   - `_active`: boolean
   - `_thread`: coroutine untuk main loop
   - `_connections`: table
   - `_state`: string (IDLE, BUYING, PLACING, HATCHING)
   - `_holdingEgg`: boolean
   - `_config`: table dengan targetMutation, cycleDelay, hatchDelay
   - `_stats`: table dengan eggsHatched, eggsBought, etc.

2. **Dependencies:**
   - Load semua sub-modules: EggBuyer, PlotManager, EggHatcher, ConveyorMonitor
   - Load Timing untuk delays

3. **init():**
   - Initialize semua sub-modules
   - Validate minimal setup (plots found)
   - Return boolean success

4. **start():**
   - Set _active = true
   - Start EggBuyer (dengan callback ke _onEggBought)
   - Spawn main loop thread

5. **stop():**
   - Set _active = false
   - Stop semua sub-modules
   - Cancel thread
   - Cleanup connections

6. **setTargetMutation(mutation):**
   - Update config
   - Update EggBuyer target

7. **mainLoop():**
   - State machine dari RESEARCH.md:
   ```
   IDLE:
     - Check ready eggs → HATCHING
     - Check holding egg → PLACING
     - Else → stay IDLE (buying handled by events)
   
   BUYING:
     - Handled by ConveyorMonitor callback
     - On success → _holdingEgg = true
   
   PLACING:
     - Find empty plot
     - Place egg
     - _holdingEgg = false
     - → IDLE
   
   HATCHING:
     - Find ready eggs
     - Hatch one by one dengan delay
     - → IDLE
   ```

8. **_onEggBought(success):**
   - Callback dari EggBuyer
   - Update _holdingEgg
   - Update stats

9. **getStats():** Return shallow copy of stats
10. **getConfig():** Return shallow copy of config
11. **setConfig(key, value):** Update config value

**Anti-detection dalam main loop:**
- Timing.wait() untuk semua delays
- State checks sebelum actions
- pcall wrapper untuk semua game interactions

**Pattern mengikuti auto-collect.lua lifecycle**
  </action>
  <verify>
1. File features/egg-system.lua exists
2. EggSystem.init() initializes all sub-modules
3. EggSystem.start() spawns main loop
4. EggSystem.stop() cleanly stops all modules
5. State machine transitions work correctly
6. All sub-module integrations connected
7. Stats tracking for eggs bought, placed, hatched
8. Module exports match auto-collect.lua pattern
  </verify>
  <done>
- Egg system orchestrator complete dengan state machine
- Integrates all sub-modules: buyer, placer, hatcher
- Complete egg loop: monitor → buy → place → hatch
- Stats tracking untuk UI display
- Lifecycle pattern consistent dengan auto-collect.lua
  </done>
</task>

</tasks>

<verification>
1. Semua 3 file exist di lokasi yang benar
2. PlotManager detects empty plots dan places eggs
3. EggHatcher detects ready eggs dan hatches them
4. EggSystem orchestrates complete loop
5. State machine: IDLE → BUYING → PLACING → HATCHING → IDLE
6. All modules follow lifecycle pattern (init/start/stop)
7. No memory leaks (connections tracked dan cleaned)
8. Anti-detection patterns applied (timing variance, pre-checks)
</verification>

<success_criteria>
- Complete egg loop berjalan: buy → place → hatch
- PlotManager handles plot detection dan placement
- EggHatcher handles ready detection dan hatch execution
- EggSystem orchestrates dengan state machine
- Modules terintegrasi dengan Plan 01 dan 02 modules
- Ready untuk UI integration di Phase 4
</success_criteria>

<output>
After completion, create `.planning/phases/03-egg-system/03-03-SUMMARY.md`
</output>
