---
phase: 03-egg-system
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - features/conveyor-monitor.lua
  - features/egg-buyer.lua
autonomous: true

must_haves:
  truths:
    - "Script dapat mendeteksi egg di conveyor berdasarkan nama mutation"
    - "Script auto-trigger callback saat target mutation muncul"
    - "Script auto-buys egg saat target muncul dan uang cukup"
    - "Script tidak buy jika uang tidak cukup (no failed request spam)"
  artifacts:
    - path: "features/conveyor-monitor.lua"
      provides: "Conveyor egg detection via DescendantAdded"
      exports: ["init", "setTargetMutation", "start", "stop", "getConveyorEggs"]
    - path: "features/egg-buyer.lua"
      provides: "Auto-buy logic dengan pre-checks"
      exports: ["init", "start", "stop", "isHoldingEgg", "buyEgg"]
  key_links:
    - from: "features/conveyor-monitor.lua"
      to: "features/egg-buyer.lua"
      via: "callback saat target egg detected"
      pattern: "onEggDetected.*callback"
    - from: "features/egg-buyer.lua"
      to: "core/money.lua"
      via: "canAfford() pre-check"
      pattern: "Money\\.canAfford"
    - from: "features/egg-buyer.lua"
      to: "config/egg-types.lua"
      via: "getPrice() untuk harga lookup"
      pattern: "EggTypes\\.getPrice"
---

<objective>
Implementasi conveyor monitoring dan auto-buy logic untuk egg system.

Purpose: Conveyor monitor mendeteksi egg dengan target mutation di conveyor belt. Egg buyer melakukan purchase dengan pre-checks (uang cukup, belum holding egg) untuk menghindari anti-cheat detection.

Output:
- features/conveyor-monitor.lua dengan event-based detection
- features/egg-buyer.lua dengan safe buy logic
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-egg-system/03-CONTEXT.md
@.planning/phases/03-egg-system/03-RESEARCH.md
@.planning/phases/03-egg-system/03-01-SUMMARY.md
@core/services.lua
@core/timing.lua
@config/egg-types.lua
@core/money.lua
@features/game-discovery.lua
@features/auto-collect.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conveyor-monitor.lua module</name>
  <files>features/conveyor-monitor.lua</files>
  <action>
Buat module features/conveyor-monitor.lua untuk mendeteksi egg di conveyor:

1. **Module state:**
   - `_targetMutation`: string, mutation yang dicari
   - `_connections`: table, untuk cleanup
   - `_conveyorPath`: Instance, path ke conveyor area
   - `_currentEggs`: table, cache eggs di conveyor saat ini

2. **Discovery function untuk find conveyor:**
   - Try common paths: workspace.Conveyor, workspace.Map.Conveyor, workspace.EggConveyor
   - Log path yang ditemukan

3. **init(conveyorPath):**
   - Set _conveyorPath (optional, auto-discover jika nil)
   - Return boolean success

4. **setTargetMutation(mutationName):**
   - Set _targetMutation (case-insensitive storage)
   - Validate dengan EggTypes.isValid() jika available

5. **start(onEggCallback):**
   - Scan existing eggs di conveyor
   - Setup DescendantAdded listener
   - Untuk setiap egg: check BillboardGui > TextLabel untuk nama mutation
   - Jika match target, call callback(egg, mutationName)
   - Handle StreamingEnabled dengan WaitForChild timeout

6. **stop():**
   - Disconnect semua connections
   - Clear _currentEggs

7. **getConveyorEggs():**
   - Return shallow copy of _currentEggs

**Pattern dari RESEARCH.md:**
```lua
function ConveyorMonitor:_checkEgg(obj, callback)
    if not obj:IsA("Model") then return end
    
    task.spawn(function()
        -- Wait for BillboardGui (StreamingEnabled)
        local billboard = obj:WaitForChild("BillboardGui", 3)
        if not billboard then return end
        
        local textLabel = billboard:FindFirstChildOfClass("TextLabel")
        if not textLabel then return end
        
        local mutationName = textLabel.Text
        
        -- Check match (case-insensitive)
        if self._targetMutation and 
           mutationName:lower():find(self._targetMutation:lower()) then
            callback(obj, mutationName)
        end
    end)
end
```

**Module lifecycle mengikuti auto-collect.lua pattern**
  </action>
  <verify>
1. File features/conveyor-monitor.lua exists
2. ConveyorMonitor.init() attempts conveyor discovery
3. ConveyorMonitor.setTargetMutation("Normal") stores target
4. ConveyorMonitor.start(callback) sets up DescendantAdded listener
5. ConveyorMonitor.stop() disconnects all connections
6. Module follows auto-collect.lua lifecycle pattern
  </verify>
  <done>
- Conveyor monitor module complete dengan event-based detection
- DescendantAdded listener untuk real-time egg detection
- Target mutation filtering case-insensitive
- Proper cleanup dengan connection tracking
  </done>
</task>

<task type="auto">
  <name>Task 2: Create egg-buyer.lua module</name>
  <files>features/egg-buyer.lua</files>
  <action>
Buat module features/egg-buyer.lua untuk auto-buy egg:

1. **Module state:**
   - `_active`: boolean
   - `_holdingEgg`: boolean, track apakah player sedang pegang egg
   - `_buyRemote`: Instance, cached RemoteEvent untuk buy
   - `_connections`: table
   - `_config`: table dengan targetMutation, enabled

2. **Dependencies:**
   - Load Money dari core/money.lua
   - Load EggTypes dari config/egg-types.lua
   - Load Timing dari core/timing.lua
   - Load ConveyorMonitor dari features/conveyor-monitor.lua

3. **init():**
   - Discover buy RemoteEvent (patterns: BuyEgg, PurchaseEgg, Buy, Purchase, GetEgg)
   - Setup holding egg detection (check Character children atau attribute)
   - Return boolean success

4. **start():**
   - Set _active = true
   - Setup ConveyorMonitor dengan callback ke _onTargetEggFound
   - Start ConveyorMonitor

5. **stop():**
   - Set _active = false
   - Stop ConveyorMonitor
   - Cleanup connections

6. **isHoldingEgg():**
   - Return _holdingEgg
   - Detection methods:
     a. Character:FindFirstChild("Egg")
     b. Player:GetAttribute("HoldingEgg")
     c. UI indicator di PlayerGui

7. **buyEgg(egg, mutationName):**
   - Pre-checks (WAJIB untuk anti-detection):
     a. Check not holding egg
     b. Check canAfford(EggTypes.getPrice(mutationName))
     c. Check hasEmptyPlot (call PlotManager jika available)
   - Fire RemoteEvent dengan timing variance
   - Try multiple argument patterns (dari RESEARCH.md)
   - Update _holdingEgg = true jika success
   - Return boolean, string (success, message)

8. **_onTargetEggFound(egg, mutationName):**
   - Internal callback dari ConveyorMonitor
   - Validate still active
   - Call buyEgg dengan timing delay

**Anti-detection patterns (CRITICAL):**
- WAJIB pre-check sebelum fire remote
- Jangan fire jika conditions tidak terpenuhi
- Gunakan Timing.wait() untuk variance
  </action>
  <verify>
1. File features/egg-buyer.lua exists
2. EggBuyer.init() discovers buy RemoteEvent
3. EggBuyer.isHoldingEgg() returns boolean
4. EggBuyer.buyEgg() does pre-checks before firing remote
5. EggBuyer.start() integrates dengan ConveyorMonitor
6. All remote fires wrapped dalam pcall
7. Module follows auto-collect.lua lifecycle pattern
  </verify>
  <done>
- Egg buyer module complete dengan pre-check anti-detection
- Integration dengan ConveyorMonitor untuk auto-buy
- Holding egg state tracking
- Multiple argument patterns untuk RemoteEvent
- Proper lifecycle (init/start/stop)
  </done>
</task>

</tasks>

<verification>
1. Kedua file exist di lokasi yang benar
2. ConveyorMonitor detects eggs via DescendantAdded (event-based, not polling)
3. EggBuyer does pre-checks BEFORE firing RemoteEvent
4. Integration: ConveyorMonitor callback -> EggBuyer.buyEgg flow works
5. All connections tracked untuk proper cleanup
6. No hardcoded paths (uses discovery patterns)
</verification>

<success_criteria>
- features/conveyor-monitor.lua detects target mutation eggs via events
- features/egg-buyer.lua buys eggs dengan pre-check anti-detection
- Modules terintegrasi: monitor triggers buyer callback
- Lifecycle pattern consistent dengan auto-collect.lua
- Ready untuk integration dengan Plan 03 (egg-system orchestrator)
</success_criteria>

<output>
After completion, create `.planning/phases/03-egg-system/03-02-SUMMARY.md`
</output>
