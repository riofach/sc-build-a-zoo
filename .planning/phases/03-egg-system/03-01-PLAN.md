---
phase: 03-egg-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config/egg-types.lua
  - core/money.lua
autonomous: true

must_haves:
  truths:
    - "Egg types tersedia sebagai table yang mudah di-update"
    - "Script dapat membaca saldo uang player dari berbagai source"
    - "Harga per mutation type dapat di-lookup"
  artifacts:
    - path: "config/egg-types.lua"
      provides: "Mutation types table dengan nama dan harga"
      exports: ["EggTypes", "getNames", "getPrice", "isValid"]
    - path: "core/money.lua"
      provides: "Money detection dari leaderstats, attributes, atau PlayerGui"
      exports: ["getPlayerMoney", "canAfford"]
  key_links:
    - from: "config/egg-types.lua"
      to: "features/egg-buyer.lua (Plan 02)"
      via: "require dan getPrice() lookup"
      pattern: "EggTypes\\.getPrice"
    - from: "core/money.lua"
      to: "features/egg-buyer.lua (Plan 02)"
      via: "canAfford() pre-check sebelum buy"
      pattern: "Money\\.canAfford"
---

<objective>
Membuat foundation config dan utility untuk egg system: egg types config yang modular dan money detection utility.

Purpose: Egg types config memungkinkan easy update saat ada mutation baru. Money detection diperlukan untuk pre-check sebelum buy egg (menghindari failed request spam yang terdeteksi anti-cheat).

Output: 
- config/egg-types.lua dengan daftar mutation dan helper functions
- core/money.lua dengan multi-source money detection
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-egg-system/03-CONTEXT.md
@.planning/phases/03-egg-system/03-RESEARCH.md
@core/services.lua
@core/config.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create egg-types.lua config module</name>
  <files>config/egg-types.lua</files>
  <action>
Buat module config/egg-types.lua yang berisi:

1. **EggTypes table** dengan mutation types yang diketahui:
   - Normal, Shiny, Electric, Christmas, Radioactive, Mythic
   - Setiap entry: `{name = "DisplayName", price = basePrice}`
   - Price adalah estimasi (akan di-validate in-game)

2. **Helper functions:**
   - `getNames()`: Return array of mutation names untuk UI dropdown
   - `getPrice(name)`: Return harga untuk mutation (case-insensitive)
   - `isValid(name)`: Return boolean apakah mutation name valid
   - `addType(name, price)`: Add custom mutation type (untuk future updates)

3. **Pattern mengikuti existing modules:**
   - Module table dengan metatable untuk clean access
   - All functions wrapped dalam pcall untuk safety
   - Return module di akhir file

**Code structure:**
```lua
local EggTypes = {
    -- Default known types (easily updatable)
    {name = "Normal", price = 100},
    {name = "Shiny", price = 500},
    -- ... more types
}

-- Helper functions
function EggTypes.getNames() ... end
function EggTypes.getPrice(name) ... end
function EggTypes.isValid(name) ... end
function EggTypes.addType(name, price) ... end

return EggTypes
```
  </action>
  <verify>
1. File config/egg-types.lua exists
2. EggTypes.getNames() returns array dengan minimal 6 entries
3. EggTypes.getPrice("Normal") returns number > 0
4. EggTypes.isValid("InvalidMutation") returns false
5. EggTypes.addType("Custom", 999) adds new type
  </verify>
  <done>
- Egg types config module complete dengan 6+ known mutations
- Helper functions (getNames, getPrice, isValid, addType) berfungsi
- Module pattern consistent dengan existing codebase
  </done>
</task>

<task type="auto">
  <name>Task 2: Create money.lua utility module</name>
  <files>core/money.lua</files>
  <action>
Buat module core/money.lua yang berisi multi-source money detection:

1. **getPlayerMoney()**: 
   - Return: `amount, source` (number, string describing source)
   - Detection priority (dari RESEARCH.md):
     a. leaderstats (check Money, Cash, Coins, Gold, Credits, Balance, Bucks)
     b. Player Attributes (check attributes dengan money-related names)
     c. PlayerGui scan (find TextLabel dengan "$" atau currency pattern)
   - Return 0, "unknown" jika tidak ditemukan

2. **canAfford(price)**:
   - Return: boolean
   - Simple helper: `getPlayerMoney() >= price`

3. **watchMoney(callback)**:
   - Optional: Setup listener untuk money changes
   - Return: connection (untuk disconnect)

4. **Pattern requirements:**
   - Use Services dari core/services.lua jika available, fallback ke direct access
   - All game access wrapped dalam pcall
   - Log source yang ditemukan untuk debugging

**Code structure dari RESEARCH.md:**
```lua
local Money = {}

local function getServices()
    -- Pattern dari existing modules
end

function Money.getPlayerMoney()
    local player = getServices().LocalPlayer
    
    -- Priority 1: leaderstats
    local leaderstats = player:FindFirstChild("leaderstats")
    if leaderstats then
        local moneyNames = {"Cash", "Money", "Coins", ...}
        for _, name in ipairs(moneyNames) do
            local currency = leaderstats:FindFirstChild(name)
            if currency and currency:IsA("ValueBase") then
                return currency.Value, "leaderstats." .. name
            end
        end
    end
    
    -- Priority 2: Attributes
    -- Priority 3: PlayerGui
    
    return 0, "unknown"
end

function Money.canAfford(price)
    local amount = Money.getPlayerMoney()
    return amount >= price
end

return Money
```
  </action>
  <verify>
1. File core/money.lua exists
2. Money.getPlayerMoney() returns number, string
3. Money.canAfford(0) returns true (always can afford 0)
4. Money.canAfford(999999999) returns false (unless player is billionaire)
5. All functions wrapped in pcall (no raw game access)
  </verify>
  <done>
- Money detection module complete dengan 3 detection methods
- getPlayerMoney() returns amount dan source string
- canAfford() helper berfungsi untuk pre-check
- Module pattern consistent dengan core/services.lua
  </done>
</task>

</tasks>

<verification>
1. Kedua file exist di lokasi yang benar
2. `local EggTypes = loadfile("config/egg-types.lua")()` works
3. `local Money = loadfile("core/money.lua")()` works
4. EggTypes dan Money modules compatible dengan existing loader pattern
5. No syntax errors (luacheck atau equivalent)
</verification>

<success_criteria>
- config/egg-types.lua berisi 6+ mutation types dengan helper functions
- core/money.lua berisi multi-source money detection
- Kedua module mengikuti existing codebase patterns
- Ready untuk digunakan oleh Plan 02 (egg-buyer)
</success_criteria>

<output>
After completion, create `.planning/phases/03-egg-system/03-01-SUMMARY.md`
</output>
