---
phase: 04-user-interface
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - loader.lua
  - ui/main.lua
autonomous: false

must_haves:
  truths:
    - "Script dapat dijalankan dan UI muncul"
    - "Toggle Auto-Collect berfungsi on/off"
    - "Toggle Egg System berfungsi on/off"
    - "Stats labels update periodic"
    - "Settings tersimpan setelah restart"
  artifacts:
    - path: "loader.lua"
      provides: "Updated loader dengan UI initialization"
      contains: "ui/main"
  key_links:
    - from: "loader.lua"
      to: "ui/main.lua"
      via: "require dan init call"
      pattern: "loadModule.*ui/main"
    - from: "ui/main.lua"
      to: "ui/stats-tracker.lua"
      via: "require dan periodic update"
      pattern: "stats-tracker"
---

<objective>
Integrasi UI dengan loader dan feature modules. Wire semua callbacks dan verify UI berfungsi di mobile.

Purpose: Menghubungkan UI ke existing feature modules dan memastikan end-to-end flow bekerja.

Output: Updated loader.lua yang initialize UI, dan verified working UI.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-user-interface/04-RESEARCH.md
@.planning/phases/04-user-interface/04-CONTEXT.md
@.planning/phases/04-user-interface/04-01-SUMMARY.md
@.planning/phases/04-user-interface/04-02-SUMMARY.md
@loader.lua
@ui/main.lua
@ui/stats-tracker.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update loader.lua untuk initialize UI</name>
  <files>loader.lua</files>
  <action>
Update loader.lua untuk:

1. **Load UI modules:**
```lua
-- Load UI modules
local StatsTracker = loadModule("ui/stats-tracker")
local UIMain = loadModule("ui/main")
```

2. **Load feature modules:**
```lua
-- Load feature modules (existing)
local AutoCollect = loadModule("features/auto-collect")
local EggSystem = loadModule("features/egg-system")
```

3. **Create Features table untuk UI:**
```lua
local Features = {
    ["auto-collect"] = AutoCollect,
    ["egg-system"] = EggSystem,
}
```

4. **Initialize UI setelah feature modules ready:**
```lua
-- Initialize UI last
if UIMain and UIMain.init then
    local success, err = pcall(function()
        UIMain.init({
            Features = Features,
            StatsTracker = StatsTracker,
        })
    end)
    if success then
        print("[Loader] UI initialized")
    else
        warn("[Loader] UI init failed: " .. tostring(err))
    end
end
```

5. **Expose StatsTracker globally untuk feature callbacks:**
```lua
-- Make StatsTracker accessible for features to increment
_G.StatsTracker = StatsTracker
```

PENTING:
- UI init harus SETELAH feature modules loaded
- Wrap dalam pcall untuk error handling
- StatsTracker perlu accessible dari feature modules
  </action>
  <verify>
```bash
grep -c "ui/main" loader.lua
grep -c "ui/stats-tracker" loader.lua
grep -c "UIMain.init" loader.lua
```
Expect: UI modules loaded dan initialized
  </verify>
  <done>
- loader.lua loads ui/stats-tracker dan ui/main
- Features table created dengan auto-collect dan egg-system
- UIMain.init() called dengan deps
- StatsTracker exposed untuk feature callbacks
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire stats increment ke feature modules</name>
  <files>ui/main.lua</files>
  <action>
Update ui/main.lua untuk memastikan stats tracking terintegrasi:

1. **Pastikan StatsTracker di-require:**
```lua
-- Di awal module atau di init()
local StatsTracker = nil

-- Di init(deps):
StatsTracker = deps.StatsTracker
```

2. **Start stats update loop di init():**
```lua
function UI:init(deps)
    -- ... existing code ...
    
    -- Start stats update loop
    self:_startStatsLoop()
    
    -- Load saved configuration LAST
    self._rayfield:LoadConfiguration()
end
```

3. **Implement _startStatsLoop():**
```lua
function UI:_startStatsLoop()
    local statsThread = task.spawn(function()
        while true do
            if self._statsTracker then
                local money = self._statsTracker.getFormattedMoney()
                local eggs = self._statsTracker.getFormattedEggs()
                
                if self._elements.MoneyLabel then
                    self._elements.MoneyLabel:Set("Money Collected: " .. money, "coins")
                end
                if self._elements.EggsLabel then
                    self._elements.EggsLabel:Set("Eggs Hatched: " .. eggs, "egg")
                end
            end
            task.wait(3) -- Update setiap 3 detik
        end
    end)
    table.insert(self._threads, statsThread)
end
```

4. **Store element references:**
```lua
-- Saat create labels, store reference
self._elements.MoneyLabel = MoneyLabel
self._elements.EggsLabel = EggsLabel
```

PENTING:
- Stats loop harus bisa di-cancel saat destroy()
- Check nil sebelum access StatsTracker methods
- Store thread reference untuk cleanup
  </action>
  <verify>
```bash
grep -c "_startStatsLoop" ui/main.lua
grep -c "StatsTracker" ui/main.lua
grep -c "Label:Set" ui/main.lua
```
Expect: Stats loop implemented dan wired
  </verify>
  <done>
- Stats update loop berjalan setiap 3 detik
- Labels di-update dengan formatted stats
- Thread di-store untuk cleanup
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify UI di Mobile</name>
  <what-built>
Complete Rayfield UI dengan:
- 5 tabs (Collect, Eggs, Stats, Settings, About)
- Auto-Collect toggle dan Interval slider
- Mutation dropdown dan Egg System toggle
- Stats display dengan periodic updates
- Settings persistence via Rayfield ConfigurationSaving
  </what-built>
  <how-to-verify>
1. Load script di Delta Executor (mobile)
2. Wait 10-15 detik setelah join game
3. Verify:
   - [ ] UI window muncul dengan title "Build A Zoo Auto-Farm"
   - [ ] 5 tabs visible dan dapat di-tap
   - [ ] Tab Collect: Toggle Auto-Collect berfungsi (on/off)
   - [ ] Tab Collect: Slider Interval dapat di-drag (1-30)
   - [ ] Tab Eggs: Dropdown Mutation menampilkan options
   - [ ] Tab Eggs: Toggle Egg System berfungsi (on/off)
   - [ ] Tab Stats: Labels menampilkan "Money Collected: 0" dan "Eggs Hatched: 0"
   - [ ] UI dapat di-minimize (tap ShowText button)
   - [ ] UI dapat di-drag ke posisi lain
4. Restart script, verify settings tersimpan (toggle states preserved)
  </how-to-verify>
  <resume-signal>
Ketik "approved" jika semua checks pass, atau describe issues yang ditemukan.
  </resume-signal>
</task>

</tasks>

<verification>
- [ ] loader.lua loads dan initializes UI
- [ ] UI muncul di mobile
- [ ] Semua tabs accessible
- [ ] Toggles berfungsi on/off
- [ ] Stats labels update
- [ ] Settings persist across restarts
</verification>

<success_criteria>
UI fully integrated dan berfungsi di mobile. User dapat control Auto-Collect dan Egg System via toggles, melihat stats, dan settings tersimpan.
</success_criteria>

<output>
Setelah selesai, buat `.planning/phases/04-user-interface/04-03-SUMMARY.md`
</output>
