---
phase: 04-user-interface
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - ui/main.lua
autonomous: true

must_haves:
  truths:
    - "Rayfield window terbuka dengan 5 tabs"
    - "Auto-Collect toggle dapat on/off"
    - "Egg System toggle dapat on/off"
    - "Mutation dropdown menampilkan egg types"
    - "Interval slider mengubah collect interval"
  artifacts:
    - path: "ui/main.lua"
      provides: "Complete Rayfield UI implementation"
      exports: ["init", "destroy"]
      min_lines: 200
  key_links:
    - from: "ui/main.lua"
      to: "sirius.menu/rayfield"
      via: "loadstring HttpGet"
      pattern: "loadstring.*sirius\\.menu"
    - from: "ui/main.lua"
      to: "features/auto-collect.lua"
      via: "callback toggle"
      pattern: "auto-collect.*start|stop"
    - from: "ui/main.lua"
      to: "features/egg-system.lua"
      via: "callback toggle"
      pattern: "egg-system.*start|stop"
---

<objective>
Membuat Rayfield UI dengan 5 tabs: Collect, Eggs, Stats, Settings, About. Implementasi semua interactive elements (toggles, slider, dropdown, labels).

Purpose: UI adalah interface utama user untuk mengontrol semua fitur auto-farm. Mobile-friendly controls dengan Rayfield library.

Output: ui/main.lua dengan complete UI implementation.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-user-interface/04-RESEARCH.md
@.planning/phases/04-user-interface/04-CONTEXT.md
@features/auto-collect.lua
@features/egg-system.lua
@config/egg-types.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Rayfield window dengan 5 tabs</name>
  <files>ui/main.lua</files>
  <action>
Buat ui/main.lua dengan struktur berikut:

**1. Module State:**
```lua
local UI = {
    _rayfield = nil,
    _window = nil,
    _tabs = {},
    _elements = {},
    _threads = {},
    _features = nil,
    _statsTracker = nil,
}
```

**2. Prevent Double-Loading (CRITICAL):**
```lua
-- Di awal sebelum loadstring
if getgenv().BuildAZooLoaded then
    if Rayfield then
        Rayfield:Destroy()
    end
    task.wait(0.5)
end
getgenv().BuildAZooLoaded = true
```

**3. Load Rayfield:**
```lua
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
```

**4. Create Window dengan ConfigurationSaving:**
```lua
local Window = Rayfield:CreateWindow({
    Name = "Build A Zoo Auto-Farm",
    Icon = 0,
    LoadingTitle = "Build A Zoo Script",
    LoadingSubtitle = "Loading...",
    Theme = "Default",
    ShowText = "Menu",
    ToggleUIKeybind = "K",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "BuildAZoo",
        FileName = "UIConfig"
    },
    KeySystem = false,
    DisableRayfieldPrompts = true,
    DisableBuildWarnings = true,
    Discord = { Enabled = false }
})
```

**5. Create 5 Tabs dengan Lucide icons:**
- TabCollect = Window:CreateTab("Collect", "coins")
- TabEggs = Window:CreateTab("Eggs", "egg")
- TabStats = Window:CreateTab("Stats", "bar-chart-2")
- TabSettings = Window:CreateTab("Settings", "settings")
- TabAbout = Window:CreateTab("About", "info")

**6. init(deps) function:**
- Accept deps object dengan Features dan StatsTracker
- Store references
- Call internal setup functions
- Call Rayfield:LoadConfiguration() di akhir

**7. destroy() function:**
- Cancel semua threads
- Rayfield:Destroy()
- Set getgenv().BuildAZooLoaded = false

PENTING per RESEARCH.md:
- Semua element WAJIB punya unique Flag untuk config saving
- Callbacks WAJIB menggunakan task.spawn() untuk loops
- Labels TIDAK auto-update, harus manual :Set()
  </action>
  <verify>
```bash
cat ui/main.lua | head -100
grep -c "CreateTab" ui/main.lua
grep -c "CreateWindow" ui/main.lua
```
Expect: 5 CreateTab calls, 1 CreateWindow call
  </verify>
  <done>
- ui/main.lua exists dengan Rayfield window
- 5 tabs created (Collect, Eggs, Stats, Settings, About)
- ConfigurationSaving enabled
- getgenv() check untuk prevent double-loading
  </done>
</task>

<task type="auto">
  <name>Task 2: Add all UI elements ke tabs</name>
  <files>ui/main.lua</files>
  <action>
Tambahkan semua UI elements ke tabs yang sudah dibuat:

**Tab Collect:**
```lua
-- Auto-Collect Toggle (default ON per CONTEXT.md)
local autoCollectThread = nil
local AutoCollectToggle = TabCollect:CreateToggle({
    Name = "Auto-Collect",
    CurrentValue = true,
    Flag = "AutoCollect",
    Callback = function(Value)
        -- Stop existing thread first
        if autoCollectThread then
            task.cancel(autoCollectThread)
            autoCollectThread = nil
        end
        Features["auto-collect"]:stop()
        
        if Value then
            autoCollectThread = task.spawn(function()
                Features["auto-collect"]:start()
            end)
        end
    end
})

-- Interval Slider
local IntervalSlider = TabCollect:CreateSlider({
    Name = "Collect Interval",
    Range = {1, 30},
    Increment = 1,
    Suffix = " seconds",
    CurrentValue = 5,
    Flag = "CollectInterval",
    Callback = function(Value)
        if Features["auto-collect"].setConfig then
            Features["auto-collect"].setConfig("cycleInterval", Value)
        end
    end
})
```

**Tab Eggs:**
```lua
-- Mutation Dropdown (FIRST, sebelum toggle)
local EggTypes = require("config/egg-types") -- atau load via pattern
local MutationDropdown = TabEggs:CreateDropdown({
    Name = "Mutation Type",
    Options = EggTypes.getNames(),
    CurrentOption = {"Normal"},
    MultipleOptions = false,
    Flag = "MutationType",
    Callback = function(Options)
        if Features["egg-system"].setTargetMutation then
            Features["egg-system"].setTargetMutation(Options[1])
        end
    end
})

-- Egg System Toggle (default OFF per CONTEXT.md)
local eggSystemThread = nil
local EggSystemToggle = TabEggs:CreateToggle({
    Name = "Egg System",
    CurrentValue = false,
    Flag = "EggSystem",
    Callback = function(Value)
        if eggSystemThread then
            task.cancel(eggSystemThread)
            eggSystemThread = nil
        end
        Features["egg-system"]:stop()
        
        if Value then
            eggSystemThread = task.spawn(function()
                Features["egg-system"]:start()
            end)
        end
    end
})
```

**Tab Stats:**
```lua
local MoneyLabel = TabStats:CreateLabel("Money Collected: 0", "coins")
local EggsLabel = TabStats:CreateLabel("Eggs Hatched: 0", "egg")

-- Periodic update function (akan di-start dari init)
local statsThread = nil
local function startStatsLoop()
    statsThread = task.spawn(function()
        while true do
            local money = StatsTracker.getFormattedMoney()
            local eggs = StatsTracker.getFormattedEggs()
            MoneyLabel:Set("Money Collected: " .. money, "coins")
            EggsLabel:Set("Eggs Hatched: " .. eggs, "egg")
            task.wait(3)
        end
    end)
end
```

**Tab Settings:**
```lua
-- Placeholder untuk future settings (Discord webhook)
TabSettings:CreateParagraph({
    Title = "Settings",
    Content = "Discord webhook settings akan ditambahkan di Phase 5."
})
```

**Tab About:**
```lua
local StatusParagraph = TabAbout:CreateParagraph({
    Title = "Script Status",
    Content = "Running"
})

TabAbout:CreateParagraph({
    Title = "Version",
    Content = "v1.0.0"
})

TabAbout:CreateParagraph({
    Title = "Credits",
    Content = "Build A Zoo Auto-Farm\nPowered by Rayfield UI"
})
```

PENTING:
- Setiap Flag harus UNIQUE
- Toggle callbacks harus stop dulu, baru start
- task.spawn() untuk semua loops
- Store thread references untuk cleanup
  </action>
  <verify>
```bash
grep -c "CreateToggle" ui/main.lua
grep -c "CreateSlider" ui/main.lua
grep -c "CreateDropdown" ui/main.lua
grep -c "CreateLabel" ui/main.lua
grep -c "Flag" ui/main.lua
```
Expect: 2 toggles, 1 slider, 1 dropdown, 2+ labels, 4+ Flags
  </verify>
  <done>
- Tab Collect: Auto-Collect toggle + Interval slider
- Tab Eggs: Mutation dropdown + Egg System toggle
- Tab Stats: Money label + Eggs label
- Tab Settings: Placeholder paragraph
- Tab About: Status, Version, Credits paragraphs
- Semua elements punya unique Flag
- Callbacks menggunakan task.spawn()
  </done>
</task>

</tasks>

<verification>
- [ ] ui/main.lua exists dengan 200+ lines
- [ ] Rayfield window dengan ConfigurationSaving
- [ ] 5 tabs dengan correct icons
- [ ] 2 toggles dengan unique Flags (AutoCollect, EggSystem)
- [ ] 1 slider dengan Flag (CollectInterval)
- [ ] 1 dropdown dengan Flag (MutationType)
- [ ] 2 labels untuk stats
- [ ] Callbacks menggunakan task.spawn() bukan blocking loops
- [ ] getgenv() check untuk prevent stacking
</verification>

<success_criteria>
UI module lengkap dengan semua tabs dan elements. Siap untuk wiring ke feature modules di Plan 03.
</success_criteria>

<output>
Setelah selesai, buat `.planning/phases/04-user-interface/04-02-SUMMARY.md`
</output>
