---
phase: 02-auto-collect-money
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - features/auto-collect.lua
autonomous: true

must_haves:
  truths:
    - "Script dapat start/stop collection loop"
    - "Script auto-collects money dari animals yang ready"
    - "Collection menggunakan randomized timing"
    - "Script tidak memory leak saat berjalan lama"
  artifacts:
    - path: "features/auto-collect.lua"
      provides: "Auto-collect money functionality"
      min_lines: 120
      exports: ["init", "start", "stop", "isActive", "getStats"]
  key_links:
    - from: "features/auto-collect.lua"
      to: "features/game-discovery.lua"
      via: "require untuk findPlayerAnimals, isMoneyReady"
      pattern: "Discovery\\.(findPlayerAnimals|isMoneyReady|findCollectRemote)"
    - from: "features/auto-collect.lua"
      to: "core/timing.lua"
      via: "Timing.wait untuk randomized delays"
      pattern: "Timing\\.wait"
---

<objective>
Implement auto-collect money loop yang menggunakan game-discovery untuk menemukan dan collect money dari semua animals.

Purpose: Fitur auto-collect pertama yang memvalidasi architecture Phase 1 bekerja dengan game sebenarnya
Output: `features/auto-collect.lua` dengan init/start/stop lifecycle dan collection loop
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auto-collect-money/02-CONTEXT.md
@.planning/phases/02-auto-collect-money/02-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md

@core/services.lua
@core/timing.lua
@loader.lua
@features/game-discovery.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auto-collect.lua dengan module structure dan lifecycle</name>
  <files>features/auto-collect.lua</files>
  <action>
Create `features/auto-collect.lua` dengan module structure sesuai RESEARCH.md patterns.

**Module State:**
```lua
local AutoCollect = {
    _active = false,
    _thread = nil,
    _connections = {},
    _discovery = nil,
    _stats = {
        cyclesCompleted = 0,
        totalCollected = 0,
        totalFailed = 0,
        lastCycleTime = 0,
    },
    _config = {
        cycleInterval = 60,      -- sesuai CONTEXT.md
        delayPerAnimal = 0.5,    -- sesuai CONTEXT.md
        maxRetries = 3,          -- sesuai CONTEXT.md
    },
}
```

**Implement `init()`:**
- Call Discovery.discoverGameStructure()
- Store result di _discovery
- Return false dengan warning jika playerFolder tidak ditemukan
- Return true jika discovery berhasil

**Implement `start()`:**
- Guard: return early jika sudah _active
- Guard: call init() jika _discovery nil
- Set _active = true
- Spawn collection loop thread via task.spawn
- Store thread di _thread

**Implement `stop()`:**
- Set _active = false
- Cancel _thread via task.cancel jika ada
- Set _thread = nil
- Disconnect semua _connections
- Clear _connections table

**Implement helper functions:**
- `isActive()` - return _active
- `getStats()` - return shallow copy of _stats
- `getConfig()` - return shallow copy of _config
- `setConfig(key, value)` - update _config value

**Module loading:**
- Load Discovery dan Timing via loadModule pattern dari loader
- Atau langsung require jika running standalone
  </action>
  <verify>
File exists dengan:
- AutoCollect table dengan _active, _thread, _connections, _discovery, _stats, _config
- init(), start(), stop(), isActive(), getStats() functions
- Proper pcall wrapping pada semua operations
  </verify>
  <done>
- AutoCollect module dengan complete state structure
- Lifecycle functions (init, start, stop) implemented
- Helper functions (isActive, getStats, getConfig, setConfig) implemented
- Thread management dengan task.spawn/task.cancel ready
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement collection cycle dan collection methods</name>
  <files>features/auto-collect.lua</files>
  <action>
Tambahkan collection logic ke `features/auto-collect.lua`.

**Implement `collectCycle()`:**
- Get animals via Discovery.findPlayerAnimals()
- Track collected dan failed counts untuk cycle
- For each animal:
  - Check _active flag, break jika false
  - Check isMoneyReady(animal)
  - If ready: call collectFromAnimal(animal)
  - Wait dengan Timing.wait(_config.delayPerAnimal)
- Update _stats setelah cycle complete
- Log warning jika failed > 0 (sesuai CONTEXT.md - error warning only)

**Implement `collectFromAnimal(animal)`:**
- Try RemoteEvent first (priority per CONTEXT.md):
  - Get _discovery.collectRemote
  - If exists: fireRemote(animal)
- Fallback to firetouchinterest:
  - Get character dan HumanoidRootPart
  - Get animal touchable part
  - Call firetouchinterest(rootPart, touchPart, 0) then (1)
- Implement retry logic (3x per CONTEXT.md)
- Return success boolean

**Implement `fireRemote(animal)`:**
- Wrap dalam pcall
- Try different argument patterns:
  - remote:FireServer(animal)
  - remote:FireServer(animal:GetAttribute("Id"))
  - remote:FireServer() -- untuk collect all
- Return success boolean

**Implement main loop (dalam start()):**
```lua
self._thread = task.spawn(function()
    while self._active do
        local success, err = pcall(function()
            self:collectCycle()
        end)
        if not success then
            warn("[AutoCollect] Cycle error: " .. tostring(err))
        end
        -- Randomized wait untuk next cycle
        Timing.wait(self._config.cycleInterval)
    end
end)
```

**Anti-patterns yang HARUS dihindari:**
- JANGAN use wait() - use Timing.wait() untuk randomization
- JANGAN skip pcall wrapping
- JANGAN forget to check _active dalam loops
- JANGAN lupa update _stats
  </action>
  <verify>
1. collectCycle() iterates animals dan calls collectFromAnimal
2. collectFromAnimal() tries remote first, fallback to touch
3. Retry logic (3x) implemented
4. Timing.wait() digunakan (bukan raw task.wait)
5. _stats updated setelah setiap cycle
  </verify>
  <done>
- collectCycle() collects dari semua ready animals
- collectFromAnimal() dengan RemoteEvent priority dan firetouchinterest fallback
- Retry logic (3x per animal per cycle)
- Proper timing dengan Timing.wait() untuk randomization
- Stats tracking (cyclesCompleted, totalCollected, totalFailed)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add memory leak prevention dan finalize module</name>
  <files>features/auto-collect.lua</files>
  <action>
Finalize module dengan memory leak prevention dan proper exports.

**Memory Leak Prevention:**
1. Di stop():
   - Verify task.cancel actually cancels thread
   - Loop through _connections dan Disconnect each
   - Clear tables: _connections = {}, _thread = nil
   
2. Track any event connections:
   - Jika ada CharacterAdded atau similar, track di _connections
   - table.insert(self._connections, event:Connect(handler))

3. Add `cleanup()` function sebagai alias untuk stop() yang lebih thorough:
   - Call stop()
   - Reset _stats ke initial values
   - Reset _discovery = nil

**Add debug helpers:**
- `getDiscovery()` - return _discovery untuk debugging
- `runOnce()` - run single collection cycle (untuk testing)

**Finalize module return:**
```lua
return {
    init = function() return AutoCollect:init() end,
    start = function() return AutoCollect:start() end,
    stop = function() return AutoCollect:stop() end,
    cleanup = function() return AutoCollect:cleanup() end,
    isActive = function() return AutoCollect:isActive() end,
    getStats = function() return AutoCollect:getStats() end,
    getConfig = function() return AutoCollect:getConfig() end,
    setConfig = function(k, v) return AutoCollect:setConfig(k, v) end,
    getDiscovery = function() return AutoCollect:getDiscovery() end,
    runOnce = function() return AutoCollect:runOnce() end,
}
```

**Add header comment:**
```lua
--[[
  features/auto-collect.lua
  Auto-collect money from animals in Build A Zoo
  
  Usage:
    local AutoCollect = require("features/auto-collect")
    AutoCollect.init()
    AutoCollect.start()  -- starts collection loop
    AutoCollect.stop()   -- stops collection loop
    
  Config (via setConfig):
    cycleInterval: seconds between collection cycles (default: 60)
    delayPerAnimal: seconds between each animal (default: 0.5)
    maxRetries: retry attempts per animal (default: 3)
--]]
```
  </action>
  <verify>
1. stop() properly cleans up thread dan connections
2. cleanup() resets all state
3. Module exports semua public functions
4. Header comment dengan usage example
5. Tidak ada potential memory leaks (uncleaned connections/threads)
  </verify>
  <done>
- Memory leak prevention dengan proper cleanup
- Debug helpers (getDiscovery, runOnce)
- Complete module exports (10 functions)
- Usage documentation di header
- No memory leaks - semua connections tracked dan disconnected
  </done>
</task>

</tasks>

<verification>
1. File `features/auto-collect.lua` exists dan syntactically valid Lua
2. Module exports: init, start, stop, cleanup, isActive, getStats, getConfig, setConfig, getDiscovery, runOnce
3. Collection loop menggunakan Timing.wait() untuk randomization
4. RemoteEvent priority dengan firetouchinterest fallback
5. Memory leak prevention: connections tracked, thread cancellable
6. Stats tracking untuk cyclesCompleted, totalCollected, totalFailed
</verification>

<success_criteria>
- [x] features/auto-collect.lua created dengan 10 exported functions
- [x] init() runs discovery dan validates game structure
- [x] start() spawns collection loop dengan task.spawn
- [x] stop() cancels thread dan disconnects connections
- [x] collectCycle() iterates animals dengan Timing.wait delays
- [x] collectFromAnimal() tries remote first, fallback to touch
- [x] Retry logic (3x) implemented
- [x] Stats tracking updated setelah setiap cycle
- [x] Memory leak prevention verified
</success_criteria>

<output>
After completion, create `.planning/phases/02-auto-collect-money/02-02-SUMMARY.md`
</output>
